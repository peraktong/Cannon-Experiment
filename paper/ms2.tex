\documentclass[11pt, oneside]{article}   	% use "amsart" instead of "article" for AMSLaTeX format
\usepackage{geometry}                		% See geometry.pdf to learn the layout options. There are lots.

\geometry{letterpaper}                   		% ... or a4paper or a5paper or ... 
%\geometry{landscape}                		% Activate for rotated page geometry
%\usepackage[parfill]{parskip}    		% Activate to begin paragraphs with an empty line rather than an indent
\usepackage{graphicx}				% Use pdf, png, jpg, or epsÂ§ with pdflatex; use eps in DVI mode
								% TeX will automatically convert eps --> pdf in pdflatex		
\usepackage{amssymb}
\usepackage{amsmath, amsthm, amssymb, amsfonts}

\usepackage{dcolumn}% Align table columns on decimal point
\usepackage{bm}% bold math

\usepackage[T1]{fontenc}
\usepackage[utf8]{inputenc}
\usepackage{authblk}

\usepackage{amsmath}

\bibliographystyle{abbrv}


%SetFonts

%SetFonts


\title{CannonRV: Measuring radial velocities with a data-driven spectral model}
\author[1]{Jason Cao\thanks{jc6933@nyu.edu}}
\author[2]{David W. hogg\thanks{david.hogg@nyu.edu}}
\author[3]{Melissa Ness\thanks{ness@mpia-hd.mpg.de}}

\affil[1]{Department of Physics,  New York University}
\affil[2]{NYU Physics - Center for Cosmology and Particle Physics
NYU Center for Data Science
Max-Planck-Institut fuer Astronomie }
\affil[3]{
Max-Planck-Institut Max-Planck-Institut fuer Astronomie 17, D-69117 Heidelberg, Germany
}

\renewcommand\Authands{ and }

  
\date{\today}						% Activate to display a given date or no date



\begin{document}
\maketitle


\section{\label{sec:level1}Abstract}


The Cannon is a powerful tool which can predict the stellar labels from fluxes, which is a data-driven machine learning model. Also, it can infer fluxes from the stellar labels. Here we use the Cannon as a tool to calibrate the radial velocities(RV) in APOGEE DR 10 by fitting the inferred fluxes with the data fluxes. Then we compare our RV shift result with the APOGEE team and conclude our method is better. The most important thing of this work is that we can calibrate the velocity by using a new method-use data-driven model to calibrate physical parameters without using physical model. This is quicker than better than traditional methods.
 
 %% second paragraph
 

 
 \section{\label{sec:level1}Assumption and method}
 
 \subsection{\label{sec:level2}Continuum normalization}
Since the Cannon need the spectrums to be normalized. The first thing we should do is to continuum normalize the combined spectrums and individual visits. The data we use is the Apstar files in APOGEE DR10, which include two combined spectrums and several individual visits and they are set to the same wavelength scale after removing the radial velocities derived by APOGEE team. There are 8575 pixels and the wave length is equally logarithmically-spaced. The wavelength starts at 1.514 $\mu m$ and ends at 1.696 $\mu m$.
\bigskip

Our method is the same as the one in Ness et al 2015. The spectrum for each visit is in Apstar files, which are already resampled onto the sample wavelength scale with 8575 pixels. First, cut all 8575 pixels into three chunks: [[371,3192], [3697,5997], [6461,8255]] to avoid gaps in the spectrum. Then, do pseudo-normalization in these three regions and obtain the pseudo-normalized flux and inverse variance. Third, put a mask on the spectrum. Finally, fit the continuum spectrum in the continuous regions by using a 3-order sinusoid function and obtain the continuum-normalized spectrum. Our method is different from the one used by the APOGEE team and we will demonstrate it works.
\bigskip

To check whether our normalization methods works, we will:

\begin{description}
  \item[1] Plot the continuum pixels for combined spectrum and individual visits, then check whether they are roughly cover the spectrum evenly.
  \item[2] Plot individual visits and compare them with the combined spectrum, they should have similar shape.
  \item[3] Infer stellar labels from the individual visits by using the Cannon and the inferred labels should be similar from the ones from the combined spectrum for the very same star.
\end{description}

For point 3
If the inferred labels from each visit are similar to the ones from the combined spectrum, the normalization works. We define $\triangle Teff$, $\triangle$ logg and $\triangle$ Fe/H as:

\begin{equation}
\triangle Teff = Teff_{inf}^{vs} - {Teff}_{inf}^{cb}
\end{equation}

\begin{equation}
\triangle logg = logg_{inf}^{vs} - logg_{inf}^{cb}
\end{equation}

\begin{equation}
\triangle Fe/H = Fe/H_{inf}^{vs} - Fe/H_{inf}^{cb}
\end{equation}


$Teff_{inf}^{vs}$ and $Teff_{inf}^{cb}$ are the inferred Teff for each visit and the combined spectrum. It's similar for $logg$ and $Fe/H$

If most of the deviations are small, the normalized spectrum for each visit doesn't lose shape, which means our normalization method works. The details are in Experiment 1.
 
\subsection{\label{sec:level2}Calibrate the spectrums}

%{\AA}
In this part we will introduce the Cannon 2, and then use a linear method to optimize the inferred spectrum. Finally calibrate both the combined spectrum and individual visits.
\bigskip

The very first thing we use is the Cannon 2. Suppose we have a trained Cannon model. The training set contains 548 stellar and each stellar spectrum has 8575 pixels. Every pixel is related to a specific wave length. It belongs to APOGEE data release 10 and has a good quality. These stellar are the very same objects as used by the APOGEE survey for the calibration of DR10. Each of them has at least nine stellar labels. But in the training step, we only use three of them $T_{eff}$, $log$ g  and $\left[Fe/H\right]$. They span the range of $3500K <T_{eff}< 5300K$, $0 <log$ $g< 5$ and $-2.5 <\left[Fe/H\right]< 0.45$. In the training step, we only use the first combined spectrum for these 548 stars to train the model.
The model we adopt

\begin{equation}
y_{jn} = v(l_n) \cdot \theta_{j} + e_{jn}
\end{equation}

\begin{equation}
y_{jn}^{inf} = v(l_n^{inf}) \cdot \theta_{j} 
\end{equation}
\bigskip

Where \(y_{jn}\) is the spectrum data for star n at wavelength pixel j. 
 \(v(l_n)\) is the vectorizing function. 
The input \(l_n\) is the label list of length K for star n and the  output 
\(v(l_n)\) is a vector of length D (D is bigger than K).
\( \theta_{j}\) is a vector of length D of parameters which controlling the model at wavelength pixel j.
\( e_{jn}\) is a noise draw or residual at pixel j for star n.
$l_n$ and $l_n^{inf}$ are stellar labels and inferred stellar labels for star n.
$y_{jn}^{inf}$ is the inferred spectrum for star n at wavelength pixel j.  


If we have a trained Cannon 2 model, $\theta_{j}$ is available. The labels we use are Teff, Log g and Fe/H. We randomly choose about 1\% of the APOGEE DR10 and make a histogram plot. The mean inverse variance of the stars is bigger than 10000 but smaller than 40000. We also exclude stars with undetermined labels. (The label is set to -10000 if it's not determined.)The number of stars is 614. Apply the Cannon 2 on these stars and obtain the inferred labels and inferred fluxes for them. 

From the normalized combined spectrum and fluxes of individual visits for the very same star, several sets of inferred labels $l_n^{inf}$ are obtained. Then put the inferred labels $l_n^{inf}$ back into formula (5), the inferred combined spectrum and inferred fluxes of individual visits for star n is available. The data spectrum we use are in Apstar files. There are two combined spectrum and several individual visits in the Apstar files. Put all of these spectrum into the trained Cannon 2 and obtain several sets of inferred labels for each star. After that, put the inferred labels back into the model and calculate the inferred combined spectrum(There should be two) and inferred fluxes of individual visits. 
\bigskip

In the following step, we deal with the combined spectrum and individual visits with the same method. $y_{j,n}$ represents one spectrum of star n at pixel j. It can be either combined spectrum or individual visit.
\bigskip

The APOGEE team set the combined spectrum and fluxes of individual visits at rest by removing the radial velocities. However, since the derived radial velocities from the APOGEE team is not 100 \% correct, these fluxes are not at rest. There are radial velocity shifts between the radial velocities from the APOGEE team and the correct radial velocities. But we can assume the shifts of radial velocities are Gaussian distributed, so the inferred fluxes generated by the Cannon 2 are at rest. This means we can use inferred fluxes to calibrate the radial velocities derived by the APOGEE team. 
\bigskip

\begin{equation}
RV_{cor} = RV_{apo} + RV_{shift}
\end{equation}

Where $RV_{cor}$, $RV_{apo}$ and $RV_{shift}$ are the correct radial velocity, radial velocity from the APOGEE team and the radial velocity shift.
\bigskip


First, we define a spectrum called optimized spectrum.

\begin{equation}
y_{j,n}^{opt}=a\cdot y_{j+1,n}^{inf}+b\cdot y_{j,n}^{inf}+c\cdot y_{j-1,n}^{inf}
\end{equation}
\bigskip

Where $y_{j,n}^{opt}$ is the optimized spectrum for star n at wavelength pixel j. We move the inferred spectrums one pixel left, 0 pixel and one pixel right to simulate the radial velocity shift of the data spectrum. 

Then we fit the optimized spectrum to the data spectrum by using the least chi-squared method. After fitting the optimized spectrum to the data spectrum, we think the optimized spectrum has the very same radial velocity shift as the data spectrum. And we can derive the correct radial velocity of the spectrum by removing the radial velocity shift. So our objective function is the chi-squared between the optimized spectrum and the spectrum data. The objective function for star n is:
\bigskip

\begin{equation}
F^{obj}_n (a,b,c)= \sum_{j=1}^{j=J} {(y_{jn} - y_{jn}^{opt})^2 \over{\sigma_{jn}^2}}
\end{equation}


$\sigma_{jn}^2$ is the data uncertainty for star n at pixel j. The number of stellar and pixel each star are N and J. Here N and J are the number of the stellar and the number of pixel each star.  Write the objective function in the form of matrix can make it simpler. 

% insert matrix


\[
 Y_n
=
\begin{bmatrix}
    y_{1,n} \\
    y_{2,n} \\
    \vdots  \\
    y_{J,n}  \\
    
\end{bmatrix}
\]

% A

\[
A_n
=
\begin{bmatrix}
    
    y_{1,n}^{inf} & y_{1,n} ^{inf} & 1\\
    y_{2,n}^{inf}&y_{2,n}^{inf}& y_{2,n}^{inf}  \\
    \vdots & \vdots & \vdots \\
    1 &y_{J,n}^{inf}&  y_{J-1,n}^{inf} \\

\end{bmatrix}
\]



% sigma-C


\[
C_n
=
\begin{bmatrix}
    
    \sigma_{1,n}^2&0&\dots&0\\
    0& \sigma_{2,n}^2&\dots&0 \\
    \vdots & \vdots & \vdots \\
    0&\dots&0&\sigma_{J,n}^2  \\

\end{bmatrix}
\]
 
\bigskip

\begin{center}
\(X_n = 
 \begin{bmatrix}
    
    a_n\\
    b_n \\
    c_n \\

\end{bmatrix}
\)
\end{center}



Now the objective function can be described as:

\begin{equation}
F^{obj}_n (a_n,b_n,c_n)= (Y_n-A_n X_n)^TC^{-1}(Y_n-A_n X_n)
\end{equation}


And the Jacobian Matrix of the objective function with respect to parameters is

\begin{equation}
J = {\partial F^{obj}_n\over \partial X_n } = 2\cdot [(Y_n-A_nX_n)^TC^{-1}]\cdot (-A_n)
\end{equation}



The dimension of the Jacobian Matrix is 1*3. To minimize the objective function, let the Jacobian Matrix be 0 and we have:

\begin{equation}
X_n = [A_n^TC_n^{-1}A_n]^{-1} \cdot [A_n^TC_n^{-1}Y_n]
\end{equation}


By using (8) we can calculate $a_n$, $b_n$ and $c_n$, which are parameters a, b and c for one spectrum of star n.

% shall we put this part in Appendix
Calculate the optimized spectrum \( y_{j,n}^{opt}\) by using (4). The Experiment 2 shows that the optimization works.
\bigskip


%Can you interpret a, b, c in terms of radial velocity? If so, how?
After obtaining $a_n$, $b_n$ and $c_n$ for these stars, we can calibrate the combined spectra of these stars. These combined spectra are stored in Apstar files, which are generated by different individual visits after resampling them onto a common, logarithmically-spaced wavelength scale, and after removing derived radial velocities of each visit. There are two combined spectrums for one star, which are obtained by different method. The radial velocities of the spectrums in Apstar files should be 0, but in fact they are not. This is because of the errors in the radial velocity measurement by the APOGEE team. 

Consider Relativistic Doppler effect. The redshift factor is defined as z. The radial velocity is positive if the star is leaving us. 

\begin{equation}
z = {{\lambda_0 - \lambda_s} \over \lambda_s} = \sqrt{{1+\beta} \over {1-\beta}} -1 \approx \beta
\end{equation}
Where $\beta ={ v \over {v_{light}}} $. $v$ is the radial velocity. $\lambda_0$ and $\lambda_s$ are the wave lengths measured at the observer and the source.$v_{light}$ is the speed of light.


The radial velocity is related to parameters a, b and c. First, we need to assume that the inferred spectrum generated by the Cannon is set at rest, which means the radial velocity of it is zero. Second, we think the radial velocity of the data spectrum is equal to the radial velocity of the optimized spectrum. This is because the optimized spectrum is obtained by fitting the inferred spectrum to the data spectrum. We set the radial velocity to be positive if the star is leaving us. 
\bigskip

The radial velocity is related to the pixels. We can obtain the velocity shift by calculating the centroid shift. The centroid in pixel can be expressed as:

\begin{equation}
pixel_c = {\sum_{j=1}^{j=J} {j*y_{jn}}\over\sum_{j=1}^{j=J} {y_{jn}}}
\end{equation}

Where j is the pixel j, $y_{jn}$ is the flux at pixel j for star n. $pixel_c$ is the spectral centroid in pixel.

If the parameters are a, b and c. Then the centroid of the spectrum in frequency is:
\begin{equation}
pixel_c = {\sum_{j=1}^{j=J} {j*(a*y_{j+1,n}+b*y_{j,n}+c*y_{j-1,n})}\over\sum_{j=1}^{j=J} {(a*y_{j+1,n}+b*y_{j,n}+c*y_{j-1,n})}}
\end{equation}

We have $\sum_{j=1}^{j=J}{y_{j-1,n}}$ = $\sum_{j=1}^{j=J}{y_{j,n}}$ =$\sum_{j=1}^{j=J}{y_{j+1,n}}$ and $\sum_{j=1}^{j=J}{(j-1)*y_{j-1,n}}$ = $\sum_{j=1}^{j=J}{j*y_{j,n}}$ =$\sum_{j=1}^{j=J}{(j+1)*y_{j+1,n}}$. So the formula can be expressed as:

\begin{equation}
pixel_c = {\sum_{j=1}^{j=J} {j*(a*y_{j,n}+b*y_{j,n}+c*y_{j,n})}\over\sum_{j=1}^{j=J} {(a*y_{j,n}+b*y_{j,n}+c*y_{j,n})}} + {\sum_{j=1}^{j=J} {(c-a)*y_{j,n}}\over\sum_{j=1}^{j=J} {(a*y_{j,n}+b*y_{j,n}+c*y_{j,n})}}
\end{equation}

The first term is the centroid of the inferred flux. The second term is the shift of the centroid, which is:

\begin{equation}
pixel_c^{shift} = {{c-a}\over{a+b+c}}
\end{equation}

Thus we have:

\begin{equation}
RV_{shift} = pixel_c^{shift}\cdot v_{pixel}
\end{equation}
Where $RV_{shift} $ is the radial velocity shift and $pixel_c^{shift}$ is the pixel centroid shift between the two spectrum.

But if 2b<a+c, which means the magnitude of the spectrum moves one pixel left or right is big, the approximation will expire because the influence of the pixels two pixels left or right can't be ignored. When this happens, we will use five parameters, which are:
$a_1$, $a_2$, $a_3$, $a_4$, $a_5$. Now the optimized spectrum is:

\begin{equation}
y_{j,n}^{opt}=a_1\cdot y_{j+2,n}^{inf}+a_2\cdot y_{j+1,n}^{inf}+a_3\cdot y_{j,n}^{inf}+a_4\cdot y_{j-1,n}^{inf}+a_5\cdot y_{j-2,n}^{inf}
\end{equation}
This means we move the inferred spectrum two pixels left, one pixel left, zero pixel, one pixel right and two pixels right and generate five new spectrums. The parameters for them are $a_1$, $a_2$, $a_3$, $a_4$, $a_5$. We only use five parameters to calculate the radial velocity shift when $2b<a+c$, where the influence of the spectrum moves two pixels left and right can't be ignore.

So the velocity shift is

\begin{equation}
RV_{shift} = v_{pixel} \cdot {{c-a}\over{a+b+c}}\qquad2b>a+c
\end{equation}

\begin{equation}
RV_{shift} = v_{pixel} \cdot {{2a_5 +a_4 - a_2 - 2a_1}\over{a_1+a_2+a_3+a_4+a_5}}\qquad2b<a+c     
\end{equation}

We will plot the histogram for the five parameters in our experiment and demonstrate moving two pixels are good enough for these $2b<a+c$cases.


\subsection{\label{sec:level2}Optimize Teff , log g and [Fe/H] simultaneously with a, b, c}

Working on it...


%% Third paragraph
 
 \section{\label{sec:level1}Experiment}
 
 \subsection{\label{sec:level2}Experiment 1}
To demonstrate the continuum normalization works well for the combined spectrums and individual visits, we plot the continuum pixels for stars with different SNR(signal to noise ratio), Teff and Logg. Here we randomly choose 5 stars with different SNR, Teff and logg and plot them in figure 1 to 5.


% star A
\bigskip

\begin{center}
\includegraphics[width=170mm]{CP_A.png}

\centerline{Fig.1 Comparison of each visit for Star A.}
\centerline{The bottom two are the combined spectrum and the others are individual visits. The black dots are continuum pixels}
\centerline{SNR of Star A is 108. Teff = 4939K Logg =2.71 }

\end{center}


% Star B
\bigskip

\begin{center}
\includegraphics[width=170mm]{CP_B.png}

\centerline{Fig.2 Comparison of each visit for Star B.}
\centerline{The bottom two are the combined spectrum and the others are individual visits. The black dots are continuum pixels}
\centerline{SNR of Star B is 139. Teff = 4872K Logg =2.91 }

\end{center}

% Star C

\bigskip

\begin{center}
\includegraphics[width=170mm]{CP_C.png}

\centerline{Fig.3 Comparison of each visit for Star C.}
\centerline{The bottom two are the combined spectrum and the others are individual visits. The black dots are continuum pixels}
\centerline{SNR of Star C is 108. Teff = 4833K Logg =2.86 }

\end{center}


% Star D

\bigskip

\begin{center}
\includegraphics[width=170mm]{CP_D.png}

\centerline{Fig.4 Comparison of each visit for Star D.}
\centerline{The bottom two are the combined spectrum and the others are individual visits. The black dots are continuum pixels}
\centerline{SNR of Star D is 150. Teff = 4534K Logg =2.24 }

\end{center}


% Star E

\bigskip

\begin{center}
\includegraphics[width=170mm]{CP_E.png}

\centerline{Fig.5 Comparison of each visit for Star E.}
\centerline{The bottom two are the combined spectrum and the others are individual visits. The black dots are continuum pixels}
\centerline{SNR of Star E is 177. Teff = 4639K Logg =2.21 }

\end{center}

\bigskip

We can also demonstrate the continuum normalization works by infer stellar labels from individual visits and compare them with one from the combined spectrum. Here we use formula 1, 2 and 3 to obtain delta-stellar labels. If they are very small, the normalization works. They are plotted in figure 6, 7 and 8.



\begin{center}
\includegraphics[width=170mm]{hist_d_teff.png}
\end{center}

\centerline{Fig.6 Histogram of Delta Teff for individual visits}
\bigskip


\begin{center}
\includegraphics[width=170mm]{hist_d_logg.png}
\end{center}

\centerline{Fig.7 Histogram of Delta logg for individual visits}



\begin{center}
\includegraphics[width=170mm]{hist_d_fe.png}
\end{center}

\centerline{Fig.8 Histogram of Delta Fe/H for individual visits}
\bigskip

We can see that these delta-stellar labels of individual visits are close to 0, which means the spectrums of individual visits don't change shape after the normalization. That's to say, the normalization works.




 \subsection{\label{sec:level2}Experiment 2}
 
 In experiment 2, we will focus on the parameters fitting for individual visits. First, we plot the histograms of parameters abc and RV shifts for individual visits.
\bigskip


\begin{center}
\includegraphics[width=170mm]{hist_abc_visits.png}
\end{center}

\centerline{Fig.9 Histogram of a,b,c for individual visits}
\bigskip


\begin{center}
\includegraphics[width=170mm]{hist_ve_visits.png}
\end{center}

\centerline{Fig.10 Histogram of RV shifts for individual visits}
\bigskip


Then, we try to find some relation between out results and FiberID, MJD(Modified Julia Date), RA and DEC. Figures 11, 12, 13, 14 and 15 shows the relation.


\begin{center}
\includegraphics[width=170mm]{dchi_vs_all.png}
\end{center}

\centerline{Fig.11 Delta-chi-squared vs MJD, FiberID, RA and DEC for individual visitis}
\bigskip



\begin{center}
\includegraphics[width=170mm]{a_vs_all.png}
\end{center}

\centerline{Fig.12 a vs MJD, FiberID, RA and DEC for individual visitis}
\bigskip



\begin{center}
\includegraphics[width=170mm]{b_vs_all.png}
\end{center}

\centerline{Fig.13 b vs MJD, FiberID, RA and DEC for individual visitis}
\bigskip



\begin{center}
\includegraphics[width=170mm]{c_vs_all.png}
\end{center}

\centerline{Fig.14 c vs MJD, FiberID, RA and DEC for individual visitis}
\bigskip


\begin{center}
\includegraphics[width=170mm]{ve_vs_all.png}
\end{center}

\centerline{Fig.15 RV shifts vs MJD, FiberID, RA and DEC for individual visitis}
\bigskip

Finally, we shows our RV shifts results are better than results from the APOGEE team. The evidences are in the following zoom-in plots.


 




  
 %% Fourth paragraph

 \section{\label{sec:level1}Discussion}
 
 Coming soon.
 
  %% Fifth paragraph

 \section{\label{sec:level1}Appendix}
 
 
Now we exclude stars with undetermined labels and re-plot the histogram of a, b and c.
 
reference
\bibliography{t_1,pubext} 



\end{document}  