\documentclass[11pt, oneside]{article}   	% use "amsart" instead of "article" for AMSLaTeX format
\usepackage{geometry}                		% See geometry.pdf to learn the layout options. There are lots.

\geometry{letterpaper}                   		% ... or a4paper or a5paper or ... 
%\geometry{landscape}                		% Activate for rotated page geometry
%\usepackage[parfill]{parskip}    		% Activate to begin paragraphs with an empty line rather than an indent
\usepackage{graphicx}				% Use pdf, png, jpg, or epsÂ§ with pdflatex; use eps in DVI mode
								% TeX will automatically convert eps --> pdf in pdflatex		
\usepackage{amssymb}
\usepackage{amsmath, amsthm, amssymb, amsfonts}

\usepackage{dcolumn}% Align table columns on decimal point
\usepackage{bm}% bold math

\usepackage[T1]{fontenc}
\usepackage[utf8]{inputenc}
\usepackage{authblk}

\usepackage{amsmath}

\bibliographystyle{abbrv}


%SetFonts

%SetFonts


\title{CannonRV: Measuring radial velocities with a data-driven spectral model}
\author[1]{Jason Cao\thanks{jc6933@nyu.edu}}
\author[2]{David W. hogg\thanks{david.hogg@nyu.edu}}
\author[3]{Melissa Ness\thanks{ness@mpia-hd.mpg.de}}

\affil[1]{Department of Physics,  New York University}
\affil[2]{NYU Physics - Center for Cosmology and Particle Physics
NYU Center for Data Science
Max-Planck-Institut fuer Astronomie }
\affil[3]{
Max-Planck-Institut Max-Planck-Institut fuer Astronomie 17, D-69117 Heidelberg, Germany
}

\renewcommand\Authands{ and }

  
\date{\today}						% Activate to display a given date or no date



\begin{document}
\maketitle


\section{\label{sec:level1}Abstract}


The Cannon, which is a data-driven machine learning model \cite{ness2015cannon}, is a powerful tool that can predict stellar labels from spectra. Also, it can infer fluxes from the stellar labels. Here we use the Cannon as a tool to calibrate radial velocities(RV) in APOGEE DR10 by fitting the inferred fluxes with the data fluxes. Then we compare our RV shift results with the ones from APOGEE team and conclude our method is better. The most important thing about this work is that we can calibrate the velocity by using a new data-driven model to calibrate physical parameters without using any physical model. This is quicker than better than traditional methods.
 
 %% second paragraph
 

 
 \section{\label{sec:level1}Assumption and method}
 
 \subsection{\label{sec:level2}Continuum normalization}
Since the Cannon needs the spectrums to be normalized. The first thing we should do is to continuum-normalize the combined spectrums and individual visits. The data we use is in Apstar files from APOGEE DR10, which include two combined spectrums and several individual visits for one star. They are set to the same rest wavelength scale after removing the radial velocities derived by APOGEE team. There are 8575 pixels and the wavelength is equally logarithmically-spaced. The wavelength starts at 1.514 $\mu m$ and ends at 1.696 $\mu m$.
\bigskip

Our method is the same as the one in Ness et al 2015 \cite{ness2015cannon}. The spectrums are in Apstar files, which are already resampled onto the sample wavelength scale with 8575 pixels. There are four steps for the normalization:


\begin{description}
 \item[1] Cut all 8575 pixels into three chunks: [[371,3192], [3697,5997], [6461,8255]] to avoid gaps in the spectrum.
 \item[2] Do pseudo-normalization in these three regions and obtain the pseudo-normalized flux and inverse variance.
 \item[3] Put a mask on the spectrum.
 \item[4] Fit the continuum spectrum in the continuous regions by using a 3-order sinusoid function and obtain the continuum-normalized spectrum.
\end{description}


This normalization method is different from the one used by the APOGEE team and we will prove it works.
\bigskip

To check whether our normalization method works, we will:

\begin{description}
  \item[1] Plot continuum pixels for combined spectrums and individual visits, then check whether they roughly cover the spectrum evenly.
  \item[2] Plot individual visits and compare them with the combined spectrum, they should have similar shapes.
  \item[3] Infer stellar labels from individual visits by using the Cannon and these inferred labels should be similar to the ones from the combined spectrum of the very same star.
\end{description}

For point 3
If the inferred labels from each visit are similar to the ones from the combined spectrum, the normalization works. We define $\triangle Teff$, $\triangle$ logg and $\triangle$ Fe/H as:

\begin{equation}
\triangle Teff = Teff_{inf}^{vs} - {Teff}_{inf}^{cb}
\end{equation}

\begin{equation}
\triangle logg = logg_{inf}^{vs} - logg_{inf}^{cb}
\end{equation}

\begin{equation}
\triangle Fe/H = Fe/H_{inf}^{vs} - Fe/H_{inf}^{cb}
\end{equation}


$Teff_{inf}^{vs}$ and $Teff_{inf}^{cb}$ are the inferred Teff for each visit and the combined spectrum. It's similar for $logg$ and $Fe/H$

If most of the deviations are small, the normalized spectrum for each visit doesn't lose shape, which means our normalization method works. The details are in Experiment 1.
 
\subsection{\label{sec:level2}Calibrate the spectrums}

%{\AA}
In this part we will introduce the Cannon 2 \cite{casey2016cannon}, and then use a linear method to optimize the inferred spectrum. Finally calibrate both the combined spectrum and individual visits. In a word, the method we use to calibrate the radial velocities of the combined spectra and individual visits is:


\begin{description}
 \item[1] Infer labels from combined spectra and individual visits. 
 \item[2] Input these labels into the Cannon and generate inferred fluxes for the combined spectra and individual visits. Use these inferred fluxes as templates to calibrate radial velocities.
 \item[3] Generate optimized fluxes and obtain parameters a, b and c. These parameters show the radial velocity shifts between the data fluxes and the inferred fluxes.
 \item[4] By assuming these inferred fluxes are at rest, derive the radial velocity shifts of these combined spectra and individual visits. Finally, obtain the radial velocities of individual visits.
\end{description}


The very first thing we shall use is the Cannon 2. Suppose we have a trained Cannon model. The training set contains 548 stellar and each stellar spectrum has 8575 pixels. Every pixel is related to a specific wavelength. It belongs to APOGEE data release 10 and has a good quality. These stellar are the very same objects as used by the APOGEE survey for the calibration of DR10. Each of them has at least nine stellar labels. But in the training step, we only use three of them $T_{eff}$, $log$ g  and $\left[Fe/H\right]$. They span the range of $3500K <T_{eff}< 5300K$, $0 <log$ $g< 5$ and $-2.5 <\left[Fe/H\right]< 0.45$. In the training step, we only use the first combined spectrum for these 548 stars to train the model.
The model we adopt

\begin{equation}
y_{jn} = v(l_n) \cdot \theta_{j} + e_{jn}
\end{equation}

\begin{equation}
y_{jn}^{inf} = v(l_n^{inf}) \cdot \theta_{j} 
\end{equation}
\bigskip

Where \(y_{jn}\) is the spectrum data for star n at wavelength pixel j. 
 \(v(l_n)\) is the vectorizing function. 
The input \(l_n\) is the label list of length K for star n and the  output 
\(v(l_n)\) is a vector of length D (D is bigger than K).
\( \theta_{j}\) is a vector of length D of parameters which controlling the model at wavelength pixel j.
\( e_{jn}\) is a noise draw or residual at pixel j for star n.
$l_n$ and $l_n^{inf}$ are stellar labels and inferred stellar labels for star n.
$y_{jn}^{inf}$ is the inferred spectrum for star n at wavelength pixel j.  


If we have a trained Cannon 2 model, $\theta_{j}$ is available. The labels we use are Teff, Log g and Fe/H. Randomly choose about 1\% of the APOGEE DR10 and make a histogram plot. The mean inverse variance of the stars is bigger than 10000 but smaller than 40000. We also exclude stars with undetermined labels. (The label is set to -10000 if it's not determined.)The number of stars is 654. Apply the Cannon 2 on these stars and obtain inferred labels and inferred fluxes of them.

From the normalized combined spectrum and fluxes of individual visits of the very same star, several sets of inferred labels $l_n^{inf}$ are obtained. Then put the inferred labels $l_n^{inf}$ back into formula (5), the inferred combined spectrum and inferred fluxes of individual visits are available. The data spectrum we use are in Apstar files. There are two combined spectrums and several individual visits in the Apstar files. Put all these spectrums into the trained Cannon 2 and obtain several sets of inferred labels for each star. After that, put the inferred labels back into the model and calculate the inferred combined spectrum(There should be two) and inferred fluxes of individual visits. 
\bigskip

In the following step, we deal with the combined spectrum and individual visits with the same method. $y_{j,n}$ represents one spectrum of star n at pixel j. It can be either combined spectrum or individual visit.
\bigskip

The APOGEE team sets the combined spectrum and fluxes of individual visits at rest by removing the radial velocities. However, since the derived radial velocities from the APOGEE team are not 100 \% correct, these fluxes are not at rest. There are radial velocity shifts between the radial velocities from the APOGEE team and the correct radial velocities. But we can assume the shifts of radial velocities are Gaussian distributed, so the inferred fluxes generated by the Cannon 2 are at rest. This means we can use inferred fluxes as templates to calibrate radial velocities derived by the APOGEE team. \cite{holtzman2013calibrations}
\bigskip

\begin{equation}
RV_{cor} = RV_{apo} + RV_{shift}
\end{equation}

Where $RV_{cor}$, $RV_{apo}$ and $RV_{shift}$ are the correct radial velocity, radial velocity from the APOGEE team and the radial velocity shift. In our experiment, we will derive the $RV_{shift}$.
\bigskip


First, we define a spectrum called optimized spectrum.

\begin{equation}
y_{j,n}^{opt}=a\cdot y_{j+1,n}^{inf}+b\cdot y_{j,n}^{inf}+c\cdot y_{j-1,n}^{inf}
\end{equation}
\bigskip

Where $y_{j,n}^{opt}$ is the optimized spectrum for star n at wavelength pixel j. We move the inferred spectrums one pixel left, 0 pixel and one pixel right to simulate the radial velocity shift of the data spectrum. 

Then we fit the optimized spectrum to the data spectrum by using the least chi-squared method. After that, we think the optimized spectrum has the very same radial velocity shift as the data spectrum. And we can derive the correct radial velocity of the spectrum by removing the radial velocity shift in formula 6. The objective function is the chi-squared between the optimized spectrum and the spectrum data. The objective function for one flux of star n is:
\bigskip

\begin{equation}
F^{obj}_n (a,b,c)= \sum_{j=1}^{j=J} {(y_{jn} - y_{jn}^{opt})^2 \over{\sigma_{jn}^2}}
\end{equation}


$\sigma_{jn}^2$ is the data uncertainty for star n at pixel j. The number of stellar and pixel each star are N and J. Here N and J are the number of the stellar and the number of pixel each star.  Write the objective function in the form of matrix can make it simpler. \cite{hogg2010data}

% insert matrix


\[
 Y_n
=
\begin{bmatrix}
    y_{1,n} \\
    y_{2,n} \\
    \vdots  \\
    y_{J,n}  \\
    
\end{bmatrix}
\]

% A

\[
A_n
=
\begin{bmatrix}
    
    y_{1,n}^{inf} & y_{1,n} ^{inf} & 1\\
    y_{2,n}^{inf}&y_{2,n}^{inf}& y_{2,n}^{inf}  \\
    \vdots & \vdots & \vdots \\
    1 &y_{J,n}^{inf}&  y_{J-1,n}^{inf} \\

\end{bmatrix}
\]



% sigma-C


\[
C_n
=
\begin{bmatrix}
    
    \sigma_{1,n}^2&0&\dots&0\\
    0& \sigma_{2,n}^2&\dots&0 \\
    \vdots & \vdots & \vdots \\
    0&\dots&0&\sigma_{J,n}^2  \\

\end{bmatrix}
\]
 
\bigskip

\begin{center}
\(X_n = 
 \begin{bmatrix}
    
    a_n\\
    b_n \\
    c_n \\

\end{bmatrix}
\)
\end{center}



Now the objective function can be described as:

\begin{equation}
F^{obj}_n (a_n,b_n,c_n)= (Y_n-A_n X_n)^TC^{-1}(Y_n-A_n X_n)
\end{equation}


And the Jacobian Matrix of the objective function with respect to parameters is

\begin{equation}
J = {\partial F^{obj}_n\over \partial X_n } = 2\cdot [(Y_n-A_nX_n)^TC^{-1}]\cdot (-A_n)
\end{equation}



The dimension of the Jacobian Matrix is (1,3). To minimize the objective function, let the Jacobian Matrix be 0 and we have:

\begin{equation}
X_n = [A_n^TC_n^{-1}A_n]^{-1} \cdot [A_n^TC_n^{-1}Y_n]
\end{equation}


By using (8) we can calculate $a_n$, $b_n$ and $c_n$, which are parameters a, b and c for one spectrum of star n.

% shall we put this part in Appendix
Calculate the optimized spectrum \( y_{j,n}^{opt}\) by using (4). The Experiment 2 shows that the optimization works.
\bigskip


%Can you interpret a, b, c in terms of radial velocity? If so, how?
After obtaining $a_n$, $b_n$ and $c_n$ for these stars, we can calibrate both the combined spectra and individual visits of these stars. Consider Relativistic Doppler effect. The redshift factor is defined as z. The radial velocity is positive if the star is leaving us. 

\begin{equation}
z = {{\lambda_0 - \lambda_s} \over \lambda_s} = \sqrt{{1+\beta} \over {1-\beta}} -1 \approx \beta
\end{equation}
Where $\beta ={ v \over {v_{light}}} $. $v$ is the radial velocity. $\lambda_0$ and $\lambda_s$ are the wave lengths measured at the observer and the source.$v_{light}$ is the speed of light.


The radial velocity is related to parameters a, b and c. First, we need to assume that the inferred spectrum generated by the Cannon is set at rest, which means the radial velocity of it is zero. Second, we think the radial velocity of the data spectrum is equal to the radial velocity of the optimized spectrum. This is because the optimized spectrum is obtained by fitting the inferred spectrum to the data spectrum. We set the radial velocity to be positive if the star is leaving us. 
\bigskip

The radial velocity is related to pixels. We can obtain the velocity shift by calculating the centroid shift. The centroid in pixel can be expressed as:

\begin{equation}
pixel_c = {\sum_{j=1}^{j=J} {j*y_{jn}}\over\sum_{j=1}^{j=J} {y_{jn}}}
\end{equation}

Where j is the pixel j, $y_{jn}$ is the flux at pixel j for star n. $pixel_c$ is the spectral centroid in pixel.

If the parameters are a, b and c. Then the centroid of the spectrum in frequency is:
\begin{equation}
pixel_c = {\sum_{j=1}^{j=J} {j*(a*y_{j+1,n}+b*y_{j,n}+c*y_{j-1,n})}\over\sum_{j=1}^{j=J} {(a*y_{j+1,n}+b*y_{j,n}+c*y_{j-1,n})}}
\end{equation}

We have $\sum_{j=1}^{j=J}{y_{j-1,n}}$ = $\sum_{j=1}^{j=J}{y_{j,n}}$ =$\sum_{j=1}^{j=J}{y_{j+1,n}}$ and $\sum_{j=1}^{j=J}{(j-1)*y_{j-1,n}}$ = $\sum_{j=1}^{j=J}{j*y_{j,n}}$ =$\sum_{j=1}^{j=J}{(j+1)*y_{j+1,n}}$. So the formula can be expressed as:

\begin{equation}
pixel_c = {\sum_{j=1}^{j=J} {j*(a*y_{j,n}+b*y_{j,n}+c*y_{j,n})}\over\sum_{j=1}^{j=J} {(a*y_{j,n}+b*y_{j,n}+c*y_{j,n})}} + {\sum_{j=1}^{j=J} {(c-a)*y_{j,n}}\over\sum_{j=1}^{j=J} {(a*y_{j,n}+b*y_{j,n}+c*y_{j,n})}}
\end{equation}

The first term is the centroid of the inferred flux. The second term is the shift of the centroid, which is:

\begin{equation}
pixel_c^{shift} = {{c-a}\over{a+b+c}}
\end{equation}

Thus we have:

\begin{equation}
RV_{shift} = pixel_c^{shift}\cdot v_{pixel}
\end{equation}
Where $RV_{shift} $ is the radial velocity shift and $pixel_c^{shift}$ is the pixel centroid shift between the two spectrum.

But if 2b<a+c, which means the magnitude of the spectrum moves one pixel left or right is big, the approximation will expire because the influence of the pixels two pixels left or right can't be ignored. When this happens, we will use five parameters, which are:
$a_1$, $a_2$, $a_3$, $a_4$, $a_5$. Now the optimized spectrum is:

\begin{equation}
y_{j,n}^{opt}=a_1\cdot y_{j+2,n}^{inf}+a_2\cdot y_{j+1,n}^{inf}+a_3\cdot y_{j,n}^{inf}+a_4\cdot y_{j-1,n}^{inf}+a_5\cdot y_{j-2,n}^{inf}
\end{equation}
This means we move the inferred spectrum two pixels left, one pixel left, zero pixel, one pixel right and two pixels right and generate five new spectrums. The parameters for them are $a_1$, $a_2$, $a_3$, $a_4$, $a_5$. We only use five parameters to calculate the radial velocity shift when $2b<a+c$, where the influence of the spectrum moves two pixels left and right can't be ignore.

So the velocity shift is

\begin{equation}
RV_{shift} = v_{pixel} \cdot {{c-a}\over{a+b+c}}\qquad2b>a+c
\end{equation}

\begin{equation}
RV_{shift} = v_{pixel} \cdot {{2a_5 +a_4 - a_2 - 2a_1}\over{a_1+a_2+a_3+a_4+a_5}}\qquad2b<a+c     
\end{equation}

We will plot the histogram for the five parameters in our experiment and demonstrate moving two pixels are good enough for these $2b<a+c$ cases.

\subsection{\label{sec:level2}Why our method is better}
% In EXP 3

The APOGEE team derive the radial velocities of individual visits by two steps. First, derive the relative radial velocity between each visit and the combined spectrum iteratively. Second, absolute radial velocity determination of the combined spectrum against a grid of synthetic spectra spanning a large range of stellar parameters. All radial velocities in these two steps are determined by cross-correlating a spectrum against a template spectrum. This means the result is very sensitive to the normalization method since the result of cross-correlation is influenced by normalization prominently. Also, the traditional synthesized spectrum in the second step is not very reliable, which means the absolute velocity is not very accurate. From these two points, there is still much to be improved in APOGEE team's RV results.
\bigskip

In experiment 3, first, we will show the RVs for individual visits from the APOGEE team is not very reliable. Then, plot our results.  Finally, argue our method gives a better RV measurement for individual visits.




\subsection{\label{sec:level2}Optimize Teff , log g and [Fe/H] simultaneously with a, b, c}

Working on it...


%% Third paragraph
 
 \section{\label{sec:level1}Experiment}
 
 \subsection{\label{sec:level2}Experiment 1}
To demonstrate the continuum normalization works well for combined spectrums and individual visits, we plot continuum pixels for stars with different SNR(signal to noise ratio), Teff and Logg. Here we randomly choose 5 stars with different SNR, Teff and logg and plot them in figure 1 to 5. If continuum pixels roughly cover the spectrums evenly, the normalization works well.


% star A
\bigskip

\begin{center}
\includegraphics[width=170mm]{CP_A.png}

\centerline{Fig.1 Comparison of each visit for Star A.}
\centerline{The bottom two are the combined spectrum and the others are individual visits. The black dots are continuum pixels}
\centerline{SNR of Star A is 108. Teff = 4939K Logg =2.71 Fe/H =-5.368}

\end{center}


% Star B
\bigskip

\begin{center}
\includegraphics[width=170mm]{CP_B.png}

\centerline{Fig.2 Comparison of each visit for Star B.}
\centerline{The bottom two are the combined spectrum and the others are individual visits. The black dots are continuum pixels}
\centerline{SNR of Star B is 139. Teff = 4872K Logg =2.91 Fe/H =3.486}

\end{center}

% Star C

\bigskip

\begin{center}
\includegraphics[width=170mm]{CP_C.png}

\centerline{Fig.3 Comparison of each visit for Star C.}
\centerline{The bottom two are the combined spectrum and the others are individual visits. The black dots are continuum pixels}
\centerline{SNR of Star C is 108. Teff = 4833K Logg =2.86 Fe/H =6.577}

\end{center}


% Star D

\bigskip

\begin{center}
\includegraphics[width=170mm]{CP_D.png}

\centerline{Fig.4 Comparison of each visit for Star D.}
\centerline{The bottom two are the combined spectrum and the others are individual visits. The black dots are continuum pixels}
\centerline{SNR of Star D is 140. Teff = 5094K Logg =3.088 Fe/H = -3.679 }

\end{center}


% Star E

\bigskip

\begin{center}
\includegraphics[width=170mm]{CP_E.png}

\centerline{Fig.5 Comparison of each visit for Star E.}
\centerline{The bottom two are the combined spectrum and the others are individual visits. The black dots are continuum pixels}
\centerline{SNR of Star E is 208. Teff = 4869K Logg =1.903 Fe/H = -1.691 }

\end{center}

These continuum pixels roughly cover the spectrums evenly, which means the normalization works well.

\bigskip

We can also demonstrate the continuum normalization works by inferring stellar labels from individual visits and compare them with the ones from combined spectrums.  Here we use formula 1, 2 and 3 to obtain delta-stellar labels. If they are very small, the normalization works. They are plotted in figure 6, 7 and 8.



\begin{center}
\includegraphics[width=170mm]{hist_d_teff.png}
\end{center}

\centerline{Fig.6 Histogram of Delta Teff for individual visits}
\bigskip


\begin{center}
\includegraphics[width=170mm]{hist_d_logg.png}
\end{center}

\centerline{Fig.7 Histogram of Delta logg for individual visits}



\begin{center}
\includegraphics[width=170mm]{hist_d_fe.png}
\end{center}

\centerline{Fig.8 Histogram of Delta Fe/H for individual visits}
\bigskip

We can see that these delta-stellar labels of individual visits are close to 0, which means the spectrums of individual visits don't change shape after the normalization. That's to say, the normalization works.




 \subsection{\label{sec:level2}Experiment 2}
 
 In experiment 2, we will focus on the parameters fitting of individual visits. First, we plot the histograms of parameters abc and RV shifts of individual visits.
\bigskip


\begin{center}
\includegraphics[width=170mm]{hist_abc_visits.png}
\end{center}

\centerline{Fig.9 Histogram of a,b,c for individual visits}
\bigskip


\begin{center}
\includegraphics[width=170mm]{hist_ve_visits.png}
\end{center}

\centerline{Fig.10 Histogram of RV shifts for individual visits}
\bigskip


Then, we try to find some relation between our results and FiberID, MJD(Modified Julia Date), RA and DEC. Figures 11, 12, 13, 14 and 15 shows the relation.


\begin{center}
\includegraphics[width=170mm]{dchi_vs_all.png}
\end{center}

\centerline{Fig.11 Delta-chi-squared vs MJD, FiberID, RA and DEC for individual visitis}
\bigskip



\begin{center}
\includegraphics[width=170mm]{a_vs_all.png}
\end{center}

\centerline{Fig.12 a vs MJD, FiberID, RA and DEC for individual visitis}
\bigskip



\begin{center}
\includegraphics[width=170mm]{b_vs_all.png}
\end{center}

\centerline{Fig.13 b vs MJD, FiberID, RA and DEC for individual visitis}
\bigskip



\begin{center}
\includegraphics[width=170mm]{c_vs_all.png}
\end{center}

\centerline{Fig.14 c vs MJD, FiberID, RA and DEC for individual visitis}
\bigskip


\begin{center}
\includegraphics[width=170mm]{ve_vs_all.png}
\end{center}

\centerline{Fig.15 RV shifts vs MJD, FiberID, RA and DEC for individual visitis}
\bigskip

We will show our results are better than APOGEE's in the next experiment.


\subsection{\label{sec:level2}Experiment 3}

Finally, we show our results are better than the results from the APOGEE team. We demonstrate it by randomly choosing 5 stars with different SNR, Teff, logg and Fe/H. Then plot the fluxes from the APOGEE team and the Cannon. We will show the inferred fluxes are at rest and our formula gives correct RV shifts.




% star 1
\bigskip

\begin{center}
\includegraphics[width=170mm]{Peak_1.png}

\centerline{Fig.16 Comparison of each visit for Star 1.}
\centerline{The bottom two in each subplot are the combined spectrum and the others are individual visits.}
\centerline{The black lines show the centers of the peaks in these fluxes}
\centerline{SNR of Star 1 is 206. Teff = 4208K Logg =1.347 Fe/H =-1.018}

\end{center}


% Star 2
\bigskip

\begin{center}
\includegraphics[width=170mm]{Peak_2.png}

\centerline{Fig.17 Comparison of each visit for Star 2.}
\centerline{The bottom two in each subplot are the combined spectrum and the others are individual visits.}
\centerline{The black lines show the centers of the peaks in these fluxes}
\centerline{SNR of Star 2 is 197. Teff = 4641K Logg =2.201 Fe/H =-5.873}

\end{center}

% Star 3

\bigskip

\begin{center}
\includegraphics[width=170mm]{Peak_3.png}

\centerline{Fig.18 Comparison of each visit for Star 3.}
\centerline{The bottom two in each subplot are the combined spectrum and the others are individual visits.}
\centerline{The black lines show the centers of the peaks in these fluxes}
\centerline{SNR of Star 3 is 117. Teff = 4902K Logg =2.639 Fe/H =-1.863}

\end{center}


% Star 4

\bigskip

\begin{center}
\includegraphics[width=170mm]{Peak_4.png}

\centerline{Fig.19 Comparison of each visit for Star 4.}
\centerline{The bottom two in each subplot are the combined spectrum and the others are individual visits.}
\centerline{The black lines show the centers of the peaks in these fluxes}
\centerline{SNR of Star 4 is 122. Teff = 4813K Logg =2.736 Fe/H = -1.832 }

\end{center}


% Star 5

\bigskip

\begin{center}
\includegraphics[width=170mm]{Peak_5.png}

\centerline{Fig.20 Comparison of each visit for Star 5.}
\centerline{The bottom two in each subplot are the combined spectrum and the others are individual visits.}
\centerline{The black lines show the centers of the peaks in these fluxes}
\centerline{SNR of Star 5 is 113. Teff = 4513K Logg =2.662 Fe/H = -5.215 }

\end{center}

\bigskip

From these plots, we can see that the peaks of fluxes from the APOGEE team have shifts from each other, which should not happen because these fluxes are set at rest by the APOGEE team and there shouldn't be shifts between them. This means radial velocities from the APOGEE team are not very accurate. When we look at the fluxes generated from the Cannon, the peaks from individual visits have the same positions. These spectrums are at rest. That's to say, we can use inferred fluxes from the Cannon as templates for calibration.
\bigskip

Then, we argue that our method for deriving the relative radial velocities(RV shifts) between inferred fluxes and data spectra is good. The APOGEE team use Cross-correlation to derive RV shifts, which is very sensitive to the normalization method. Also, Cross-correlation means we need to interpolate the data, which may cause the broadening of the spectrum. Here most of the RV shifts are smaller than one pixel(Figure 10) and this means the cross-correlation may not be very reliable. 

Our method is to move the inferred fluxes one pixel left and right. It uses two adjacent pixels and the pixel itself to calibrate each pixel. The prerequisite of this method is that the middle pixel accounts for a bigger proportion than the other two. This means considering three pixels is good enough. In figure 9, we can see that most b are close to 1 and most a, c are close to 0. This means our method works good for most of these cases. Even for the case that 2b<a+c, which means we need to consider at least 5 pixels. Our formula 20 gives a good expression. Since all the RV shifts in figure10 is smaller than 2 pixels, we don't need to consider 7 or more pixels. 

In conclusion, the method we use to determine the RV shifts is good. It gives more accurate radial velocities than the APOGEE team.

  
 %% Fourth paragraph

 \section{\label{sec:level1}Discussion}
 
 Coming soon.
 
  %% Fifth paragraph

 \section{\label{sec:level1}Appendix}
 
 
Now we exclude stars with undetermined labels and re-plot the histogram of a, b and c.
 
reference
\bibliography{citation,pubext} 



\end{document}  