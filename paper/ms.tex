\documentclass[11pt, oneside]{article}   	% use "amsart" instead of "article" for AMSLaTeX format
\usepackage{geometry}                		% See geometry.pdf to learn the layout options. There are lots.

\geometry{letterpaper}                   		% ... or a4paper or a5paper or ... 
%\geometry{landscape}                		% Activate for rotated page geometry
%\usepackage[parfill]{parskip}    		% Activate to begin paragraphs with an empty line rather than an indent
\usepackage{graphicx}				% Use pdf, png, jpg, or epsÂ§ with pdflatex; use eps in DVI mode
								% TeX will automatically convert eps --> pdf in pdflatex		
\usepackage{amssymb}
\usepackage{amsmath, amsthm, amssymb, amsfonts}

\usepackage{dcolumn}% Align table columns on decimal point
\usepackage{bm}% bold math

\usepackage[T1]{fontenc}
\usepackage[utf8]{inputenc}
\usepackage{authblk}


%SetFonts

%SetFonts


\title{CannonRV: Measuring radial velocities with a data-driven spectral model}
\author[1]{Jason Cao\thanks{jc6933@nyu.edu}}
\author[2]{David W. hogg\thanks{david.hogg@nyu.edu}}
\author[3]{Melissa Ness\thanks{ness@mpia-hd.mpg.de}}

\affil[1]{Department of Physics,  New York University}
\affil[2]{NYU Physics - Center for Cosmology and Particle Physics
NYU Center for Data Science
Max-Planck-Institut fuer Astronomie }
\affil[3]{
Max-Planck-Institut Max-Planck-Institut fuer Astronomie 17, D-69117 Heidelberg, Germany
}

\renewcommand\Authands{ and }

  
\date{\today}						% Activate to display a given date or no date



\begin{document}
\maketitle


\section{\label{sec:level1}Introduction}


Coming soon...
 
 %% second paragraph
 
 \section{\label{sec:level1}Assumption and method}
 \subsection{\label{sec:level2}Optimize the spectrum}

%{\AA}
Suppose we have a trained model. The training set contains 548 stellar and each stellar spectrum has 8575 pixels. Every pixel is related to a specific wave length. It belongs to APOGEE data release 10 and has a good quality. These stellar are the very same objects as used by the APOGEE survey for the calibration of DR10. Each of them has at least nine stellar labels. But in the training step, we only use three of them $T_{eff}$, $log$ g  and $\left[Fe/H\right]$. They span the range of $3500K <T_{eff}< 5300K$, $0 <log$ $g< 5$ and $-2.5 <\left[Fe/H\right]< 0.45$. The spectrum we use in the training and testing step of the cannon is the combined spectrum from aspcap files. The labels we use are from the Allstar visit file.


The model we adopt

\begin{equation}
y_{jn} = v(l_n) \cdot \theta_{j} + e_{jn}
\end{equation}

                   
 
 Where \(y_{jn}\) is the spectrum data for star n at wavelength pixel j. 
 \(v(l_n)\) is the vectorizing function. 
The input \(l_n\) is the label list of length K for star n and the  output 
\(v(l_n)\) is a vector of length D (D is bigger than K).
\( \theta_{j}\) is a vector of length D of parameters which controlling the model at wavelength pixel j.
\( e_{jn}\) is a noise draw or residual at pixel j for star n.


\(l_n^{inf}\) and \( \theta_{j}\) are available after the training step.
Infer spectrum by using:

\begin{equation}
y_{jn}^{inf} = v(l_n^{inf}) \cdot \theta_{j} 
\end{equation}

 
 This is how to obtain the synthesized spectrum by using the Cannon 2. We also call it inferred flux(spectrum).

The Cannon 2 can predict the spectrum pretty well. But we can still improve it.
\bigskip

From the inferred spectrum \(y_{jn}^{inf}\), we optimize it and generate a better synthesized spectrum, which we call \(y_{jn}^{opt}\).
\bigskip

The method we use is to represent the spectrum at pixel j by using the inferred spectrum at pixel j-1,pixel j and pixel j+1.(If the pixel is out of range, set the flux as 1). The data we use is the same as the training step.
\bigskip

The new spectrum, which is the optimized spectrum, is represented by:

\begin{equation}
y_{j,n}^{opt}=a\cdot y_{j-1,n}^{inf}+b\cdot y_{j,n}^{inf}+c\cdot y_{j+1,n}^{inf}
\end{equation}
\bigskip

We use the least chi-squared method. So our objective function is the chi-squared between the optimized spectrum and the spectrum data. The objective function for star n is:
\bigskip

\begin{equation}
F^{obj}_n (a,b,c)= \sum_{j=1}^{j=J} {(y_{jn} - y_{jn}^{opt})^2 \over{\sigma_{jn}^2}}
\end{equation}


$\sigma_{jn}^2$ is the data uncertainty for star n at pixel j. The number of stellar and pixel each star are N and J. Here N and J are the number of the stellar and the number of pixel each star.  Write the objective function in the form of matrix can make it simpler. There will be N objective functions and N sets of a, b and c. So we introduce several matrix: $Y_n$, $A_n$, $C_n$ and $X_n$, which are defined as followed:

% insert matrix


\[
 Y_n
=
\begin{bmatrix}
    y_{1,n} \\
    y_{2,n} \\
    \vdots  \\
    y_{J,n}  \\
    
\end{bmatrix}
\]

% A

\[
A_n
=
\begin{bmatrix}
    
    1 & y_{1,n} ^{inf} & y_{2,n} ^{inf}\\
    y_{1,n}^{inf}&y_{2,n}^{inf}& y_{3,n}^{inf}  \\
    \vdots & \vdots & \vdots \\
    y_{J-1,n}^{inf}&y_{J,n}^{inf}& 1  \\

\end{bmatrix}
\]



% sigma-C


\[
C_n
=
\begin{bmatrix}
    
    \sigma_{1,n}^2&0&\dots&0\\
    0& \sigma_{2,n}^2&\dots&0 \\
    \vdots & \vdots & \vdots \\
    0&\dots&0&\sigma_{J,n}^2  \\

\end{bmatrix}
\]
 
\bigskip

\begin{center}
\(X_n = 
 \begin{bmatrix}
    
    a_n\\
    b_n \\
    c_n \\

\end{bmatrix}
\)
\end{center}



Now the objective function can be described as:

\begin{equation}
F^{obj}_n (a_n,b_n,c_n)= (Y_n-A_n X_n)^TC^{-1}(Y_n-A_n X_n)
\end{equation}


And the Jacobian Matrix of the objective function with respect to parameters is

\begin{equation}
J = {\partial F^{obj}_n\over \partial X_n } = 2\cdot [(Y_n-A_nX_n)^TC^{-1}]\cdot (-A_n)
\end{equation}



The dimension of the Jacobian Matrix is 1*3. To minimize the objective function, let the Jacobian Matrix be 0 and we have:

\begin{equation}
X_n = [\sum_{n=1}^{n=N}A_n^TC_n^{-1}A]^{-1} \cdot [\sum_{n=1}^{n=N}A^TC_n^{-1}Y_n]
\end{equation}


By using (7) we can calculate $a_n$, $b_n$ and $c_n$, which are parameters a, b and c for star n. 
b should be much bigger than both a and c. And a+b+c should be equal to 1. 


Calculate the optimized spectrum \( y_{j,n}^{opt}\) by using (3). The Experiment 1 shows that the optimization works.
\bigskip




%It works!


\subsection{\label{sec:level2}Spectrum calibration}
\bigskip
After the optimization, we obtain many sets of a, b and c. In our theory b should be close to 1 and a, c is much smaller than b. But the fact is that sometimes b is much smaller than and c. This is because of the spectral broadening in the measurement. The equipment is not perfect, so the resolution of the spectrum will become lower due to scattering, dispersion or other reasons. Then the spectrum will broaden and the real spectrum at pixel j is not what we obtain, it should be the spectrum at nearby pixels, which include pixel j-1 and j+1. Thus b will be smaller than a+c, which we will discuss in the following experiment 3.
\bigskip

Sometimes a or c will be much bigger than the other two parameters. This is also because of the measurement. Even we ignore the spectral broadening, the measured spectrum may move one pixel left or one pixel right from the real spectrum. If the measured spectrum move one pixel left, then a should be close to 1 and it's similar for c. The measured spectrum moves left or right is because of the error in the measured velocity, so there will be error in measuring the Doppler effect, which leads to a spectrum moving. We will show this in experiment 3.

We will do this optimization for each visit of every star in APOGEE DR10. The spectrum we use is in apstar file. We will re-analyze the velocities after the optimization and deliver back the velocities correction for the APOGEE data.
\bigskip

\subsection{\label{sec:level2} Interpret a, b, c in term of radial velocity}

%Can you interpret a, b, c in terms of radial velocity? If so, how?
After obtaining a, b and c for these stars, we can calibrate the errors in the radial velocities of the combined spectra of these stars. These combined spectra are stored in Apstar files, which are generated by different individual visits after resampling them onto a common, logarithmically-spaced wavelength scale, and after removing derived radial velocities of each visit. The apStar files also include the individual visit spectra, resampled and shifted to rest wavelength. If we need to use the individual visits before resampling, apVisit files are needed. In our experiment, we use the resampled spectrum in Apstar files. The radial velocities of the spectrum in Apstar files should be 0, but in fact they are not. This is because of the errors in radial velocity measurement by the APOGEE team. The APOGEE team determines the radial velocities of the stars by two steps.
\bigskip
\\
1. Estimate the radial velocity of each visit by cross-correlating the visit spectrum against a grid of synthetic spectra.
\\
2. Compare the spectrum of each visit with the combined spectrum and re-derive the radial velocity for each visit iteratively. 
\bigskip

After obtaining the velocities, the APOGEE team uses the de-Doppler wavelengths and resample the spectrum onto the final logarithmically-spaced wavelength scale by using sinc interpolation. Finally, generate the combined spectrum by using the spectrums of different visits. Both combined spectrum and each visit may have radial velocity errors because the synthetic spectra are not perfect.


We will derive these radial velocity errors, then de-Doppler them and resample the fluxes onto a common, logarithmically-spaced wavelength scale, which is the same as the wavelength scale in Apstar and ASPCAP flies.

Consider Relativistic Doppler effect. The redshift factor is defined as z. The radial velocity is positive if the star is leaving us. 

\begin{equation}
z = {{\lambda_0 - \lambda_s} \over \lambda_s} = \sqrt{{1+\beta} \over {1-\beta}} -1 \approx \beta
\end{equation}
Where $\beta ={ v \over c} $. $v$ is the radial velocity. $\lambda_0$ and $\lambda_s$ are the wave lengths measured at the observer and the source.

The data spectrum we use in experiment 1 to 4 is the combined spectrum and we start to use spectrum of each visit in experiment 5.

The radial velocity is related to parameters a, b and c. First, we need to assume that the inferred spectrum generated by the Cannon is set at rest, which means the radial velocity of it is zero. Second, we think the radial velocity of the data spectrum is equal to the radial velocity of the optimized spectrum. This is because the optimized spectrum is obtained by fitting the inferred spectrum to the data spectrum. 
\bigskip

To begin with, we set the radial velocity to be positive if the star is leaving us. If a=1, b=0 and c=0, the optimized spectrum moves one pixel left from the inferred spectrum, which means the data spectrum should move one pixel right and the radial velocity of the data spectrum is not zero and it has a blue shift. Thus the radial velocity correction is negative and can be obtained by using (8). It's more convenient to use the logarithmic wavelength.
\begin{equation}
\log_{10}\lambda_0 - \log_{10}\lambda_s = \log_{10}(1+\beta)
\end{equation}

All spectrums in Apstar files are set to the same wavelength scale. The wavelength start at 15100.802 $\AA$ and the logarithmic wavelength grid spacing between two pixels is $6*10^{-6}$. By using (9), we find that one pixel is related to radial velocity 4144.68 m/s, which means if a=1 b= 0 and c=0, the radial velocity error in the APOGEE data is $-4144.68 m/s$

Thus we can use a, b and c to determine the radial velocity correction for the combined spectrum and each visit of the APOGEE data.
\begin{equation}
v_{deviation} = (c-a)*v_{pixel}
\end{equation}
Where $v_{deviation}$ is the deviation of the APOGEE data and $v_{pixel}$ =  4144.68 m/s.




\subsection{\label{sec:level2} Obtain information from the individual exposures}

%How do you continuum-normalize the individual exposures, and can you demonstrate to me that your proposal of how to do that is working well?

Before deriving a, b and c for each visit, we need to continuum-normalize the spectrum of each visit. This is because the absolute value of each visit is different. Therefore, each visit spectrum needs to be roughly continuum normalized before they are combined. The APOGEE team uses a median filter to continuum-normalize the spectrum of each visit. 
\bigskip

Our method is the same as the one in Ness et al 2015. The spectrum for each visit is in Apstar files, which are already resampled onto the sample wavelength scale with 8575 pixels. First, cut all 8575 pixels into three chunks: [[371,3192], [3697,5997], [6461,8255]] to avoid gaps in the spectrum. Then, do pseudo-normalization in these three regions and obtain the pseudo-normalized flux and inverse variance. Third, put a mask on the spectrum. Finally, fit the continuum spectrum in the continuous regions by using a 3-order sinusoid function and obtain the continuum-normalized spectrum. Our method is different from the one used by the APOGEE team and we will demonstrate it works.


To check whether it works, we can look at the normalized spectrum of each visit. If the absolute value of the normalized flux for each visit is similar to each other, the normalization works.

Also, we can infer labels by using the normalized flux of each visit. If the inferred labels from each visit are similar to the ones from the combined spectrum, the normalization works. We define $\triangle Teff$, $\triangle$ logg and $\triangle$ Fe/H as:

\begin{equation}
\triangle Teff = Teff_{inf}^{vs} - {Teff}_{inf}^{cb}
\end{equation}

\begin{equation}
\triangle logg = logg_{inf}^{vs} - logg_{inf}^{cb}
\end{equation}

\begin{equation}
\triangle Fe/H = Fe/H_{inf}^{vs} - Fe/H_{inf}^{cb}
\end{equation}


$Teff_{inf}^{vs}$ and $Teff_{inf}^{cb}$ are the inferred Teff for each visit and the combined spectrum. It's similar for $logg$ and $Fe/H$

If most of the deviations are small, the normalized spectrum for each visit doesn't lose shape, which means our normalization method works. 




The details are in experiment 5.






\subsection{\label{sec:level2}Optimize Teff , log g and [Fe/H] simultaneously with a, b, c}

Working on it...


%% Third paragraph
 
 \section{\label{sec:level1}Experiment}
 \subsection{\label{sec:level2}Experiment 1}
 
Choose four stellar, which are not in the training set. Optimize the spectrum of these four stars and obtain a, b and c for each stars. The labels we use in the figures are from the Cannon, which means they are inferred labels.
 
The labels of the four stars are:
\begin{center}
 
 Star A  $T_{eff} =4750$  log g =3.0 $\left[Fe/h\right] =0.15$
 
 Star B  $T_{eff} =4849$  log g =2.2 $\left[Fe/h\right] =-1.0$
 
 Star C  $T_{eff} =3614$  log g =0.4 $\left[Fe/h\right] =-0.68$
 
 Star D  $T_{eff} =5003$  log g =2.8 $\left[Fe/h\right] =-0.71$
 
 \end{center}
 
 
\begin{table}[ht]
\caption{Fitting results for the four stars}
\centering
\begin{tabular}{c c c c c}
\hline\hline
Star Name & a & b & c & a+b+c \\ [0.5ex] % inserts table %heading
\hline
Star A & 0.121 & 0.824 & 0.052 & 0.998 \\
Star B & 0.176 & 0.541 &  0.278 & 0.995 \\
Star C & 0.003 & 1.004 &  -0.007 & 1.000 \\
Star D & -0.009  & 1.029 & -0.020 & 1.000 \\ [1ex]
\hline
\end{tabular}
\label{table:nonlin}
\end{table}
 

 
 
 Then plot the spectrum. The spectrum we use is the combined non-normalized spectrum from apstar files.
 
 The black line "Observed" is the observed spectrum from the data  \(y_{jn}\).
 The green line "inferred" is \( y_{j,n}^{inf}\) , which is generated by the Cannon 2.
 The red line "optimized" is \( y_{j,n}^{opt}\), which is generated by (3)
 
\bigskip


 
\includegraphics[width=170mm]{figure_1.png}
 \centerline{Fig.1 The spectrum of Star A, B, C and D}
 
 \centerline{The black line is the observed spectrum. The green line is the inferred spectrum and the red line is the optimized spectrum.}
\bigskip


 
Finally compare the chi-square for these four stars of the two methods:
The total chi-squared of the four stars becomes 2\% smaller, which means our method works.
  
 \subsection{\label{sec:level2}Experiment 2}
 Plot the parameters a, b and c vs the number of the star. 
 \bigskip
 
In experiment 1, we use only four stars to obtain parameters a, b and c and the result is pretty good.  What if we optimize more stars? We randomly choose about 1\% of the APOGEE DR10 and make a histogram plot. The mean inverse variance of the stars is bigger than 10000 but smaller than 40000. We also exclude stars with undetermined labels. (The label is set to -10000 if it's not determined.)The number of stars is 614. Now parameters a, b and c are obtained from independent stars, which means the objective function only contain the chi-squared of one star and there will be 614 objective functions. And there will be 614 sets of a, b and c. The spectrum we use is the combined non-normalized spectrum from apstar files. And soon we will use the individual visit non-normalized spectrum from apstar files. Before using these spectrum, normalization is needed. The normalization method we use is the same as the one in Ness et al 2015. The labels we use are from the Cannon, which means they are inferred labels.


We plot a, b, c against the mean fiber number, which is the average fiber number of the spectrum we optimize. In APOGEE DR 10, the fiber number is between 1 and 640. The parameters we use are from figure 3

\includegraphics[width=170mm]{figure_2.png}
\bigskip

\centerline{Fig.2 a,b,c vs Mean Fiber Number}
\bigskip

This figure gives us information about the relation between parameters a, b, c and fiber number, which can be used to establish a data-driven spectrum calibration model.
\bigskip

We also plot delta-chi-squared vs Mean Fiber number, where delta-chi-squared is the difference between the chi-squared of the spectrum before our optimization and after. It should be bigger than 0.
\bigskip

\includegraphics[width=170mm]{figure_3.png}
\bigskip

\centerline{Fig.3 Delta-chi-squared vs Mean Fiber Number}
\bigskip

\subsection{\label{sec:level2}Experiment 3}

\bigskip
Now choose some examples from the 614 stars and make some plots.Sometimes the inferred spectrum doesn't look like the data, which is already described in Ness et al 2015. We don't use these stars in the plots.



First, plot the four stars with biggest delta-chi-squared and smallest delta-chi-squared:

\includegraphics[width=170mm]{figure_4.png}
\bigskip

\centerline{Fig.4 Spectrum of the four stars with biggest delta-chi-squared. }

\centerline{The black line is the observed spectrum. The green line is the inferred spectrum and the red line is the optimized spectrum.}
\bigskip


\includegraphics[width=170mm]{figure_5.png}
\bigskip

\centerline{Fig.5 Spectrum of the four stars with smallest delta-chi-squared. }

\centerline{The black line is the observed spectrum. The green line is the inferred spectrum and the red line is the optimized spectrum.}
\bigskip

From figure 6 and 7, we find that the four stars with smallest delta-chi-squared have b closer to 1, but the four stars with biggest delta-chi-squared don't.

Also, we want to look into the spectral broadening.
Plot four stars with b closest to 1:
\bigskip

\includegraphics[width=170mm]{figure_6.png}
\bigskip

\centerline{Fig.6 Spectrum of the four stars with b closest to 1. }

\centerline{The black line is the observed spectrum. The green line is the inferred spectrum and the red line is the optimized spectrum.}
\bigskip

From the histogram of a, b and c, we also find that sometimes b becomes much smaller than a+c, which means the spectrum is broadening due to the measurement. The resolution of the spectrum becomes lower and this is what we want to calibrate.
\bigskip
Here is the plot of the four stars with biggest a+c-b:
\bigskip

\includegraphics[width=170mm]{figure_7.png}
\bigskip

\centerline{Fig.7 Spectrum of the four stars with biggest a+c-b. }

\centerline{The black line is the observed spectrum. The green line is the inferred spectrum and the red line is the optimized spectrum.}
\bigskip


\bigskip

We found a and c are close to 1, which is in accordance with our theory. 
Also, the optimized spectrum broaden when a+c is much bigger than b, which means the measured spectrum broaden due to the error in the measurement. This is what we need to calibrate.
\bigskip

To look deeper into the results, we also choose the four stars with biggest $a-c$ and biggest $c-a$. Then make another two plots:
\bigskip

\includegraphics[width=170mm]{figure_8.png}
\bigskip

\centerline{Fig.8 Spectrum of the four stars with biggest $a-c$.}

\centerline{ The black line is the observed spectrum. The green line is the inferred spectrum and the red line is the optimized spectrum.}
\bigskip



\bigskip

\includegraphics[width=170mm]{figure_9.png}
\bigskip

\centerline{Fig.9 Spectrum of the four stars with biggest $c-a$.}

\centerline{ The black line is the observed spectrum. The green line is the inferred spectrum and the red line is the optimized spectrum.}
\bigskip

For spectrum with $a>c$, the optimized spectrum moves left a little bit, which means the real spectrum should move right a little. It's similar for $c>a$. The c>a branch is not as obvious as the a>c branch.

\subsection{\label{sec:level2}Experiment 4}

\bigskip
We also plot the inferred labels $Teff$ against log g. The color bar shows the mean inverse variance of these stars.

\includegraphics[width=170mm]{figure_10.png}
\bigskip

\centerline{Fig.10 $Teff$ vs $log g$}
\bigskip

\subsection{\label{sec:level2}Experiment 5}

Here we choose the four stars with biggest a-c and obtain the radial velocity corrections for them. The spectrum we use are continuum-normalized combined spectrum of these four stars. Then we derive their radial velocity corrections and de-Doppler the wavelengths. Use Sinc interpolation to resample them onto the same wavelength scale and obtain the calibrated spectrum. The wavelength scale is the same as the one in Apstar file, which is described in the former section. Finally, plot the data spectrum and the calibrated spectrum in figure 11.

\includegraphics[width=170mm]{figure_11.png}
\bigskip

\centerline{Fig.11 Comparison of the calibrated spectrum and the data spectrum for the four stars with biggest a-c}

\centerline{ The black line is the data spectrum. The green line is the inferred spectrum and the red line is the calibrated data spectrum}
\bigskip

We do the same thing four the four stars with biggest c-a.


\includegraphics[width=170mm]{figure_12.png}
\bigskip

\centerline{Fig.12 Comparison of the calibrated spectrum and the data spectrum for the four stars with biggest c-a.}

\centerline{ The black line is the data spectrum. The green line is the inferred spectrum and the red line is the calibrated data spectrum}
\bigskip


After that, we want to calibrate the spectrum for each visit. To begin with, we need to check whether our normalization works in each visit. The method is to infer labels for each visit and compare them with the ones from the combined spectrum. If our normalization works, the inferred labels from each visit for the same star should be similar to the ones from the combined spectrum. We plot the histogram which shows the deviations of the inferred labels of each visit from the ones generated by the combined spectrum of the same star. The data we use is the 614 stars in experiment 1 to 4. If most of the deviations are small, the normalized spectrum for each visit doesn't lose shape, which means our normalization method works.

\includegraphics[width=170mm]{figure_13.png}
\bigskip

\centerline{Fig.13 Histogram for Delta Teff}
\bigskip


\includegraphics[width=170mm]{figure_14.png}
\bigskip

\centerline{Fig.14 Histogram for Delta logg}


\bigskip

\includegraphics[width=170mm]{figure_15.png}
\bigskip

\centerline{Fig.15 Histogram for Delta Fe/H}
\bigskip

We can see that most of the deviations are close to 0, which means our normalization for each visit doesn't make the spectrum distort.

In figure 16, we plot the continuum-normalized fluxes of all visits for the first star in figure 8. There are 9 individual visits. We can see that the absolute value of the flux for each visit is similar to each other, which means our normalization works.

\includegraphics[width=170mm]{figure_16.png}
\bigskip

\centerline{Fig.16 Comparison of each visit for the first star in figure 8.}
\bigskip






  
 %% Fourth paragraph

 \section{\label{sec:level1}Discussion}
 
 Coming soon.
 
  %% Fifth paragraph

 \section{\label{sec:level1}Appendix}
 
 
 Now we exclude stars with undetermined labels and re-plot the histogram of a, b and c.
 \bigskip


\includegraphics[width=170mm]{d_figure_1.png}
\bigskip

\centerline{Diagnostic Fig.1 Histogram of a b c for apstar data (What we use now)}
\bigskip





\end{document}  